# MODE Integration Guide for data collection on iOS devices

The MODE smartphone library (`libmode`) provides a complete, out-of-the-box
solution for mobility data collection via smartphones. It is built as an
autonomous component that can easily be integrated into third party apps. For
the standard use-case (trip data collection) the library can be integrated into
existing Apps with little effort:

The most recent version of the MODE library will be provided by AIT
[upon request](mailto:martin.stubenschrott@ait.ac.at). 

You will also be granted Git access to 
https://gitlab.ait.ac.at/energy/commons/smartsurvey/ios/SmartSurveyDemoApp/
which hosts a very basic demo app, showing how to use the MODE library.

**Step 1: Add the library to the App as a build dependency**

To make it easy to use libmode, we have published the library on our
Gitlab in https://gitlab.ait.ac.at/energy/commons/smartsurvey/ios/Libmode.git

You can then [add the swift package as a dependency](https://alexandersandberg.com/articles/managing-package-dependencies-with-swift-package-manager-in-xcode/)
in XCode.


**Step 2: Initialize the library and start data collection**

The library needs to be initialized before it can start recording data: 

```swift
func initLibMode() {
    // Allow uploading of trips also on cellular connection (default is Wi-Fi only)
    UserDefaultsStore.cellularUploadAllowed = true
    
    // Set the OAUTH2 token and the server address where trips are uploaded and analyzed.
    Mode.setAuthorizationToken(token: "myuser:abcdef123456")

    // Define where the backend server is located, waiting for the trips to be
    // uploaded
    //
    // By default, access to non-https is disabled by iOS. For development purposes one can change
    // Info.plist like described here, but that might not allow the app to be
    // accepted in the app store, so only use during development or install a local
    // SSL certificate:
    // https://stackoverflow.com/questions/63597760/not-allowed-to-make-request-to-local-host-swift
    Mode.setBaseServerURL(surveyUrl: "http://localhost:8080")
    
    // This call starts recording trip data. Once it has detected a trip, it is uploaded and analyzed
    Mode.startSurvey()
}
```

Also make sure that you request background location access in the manifest of the
project.

## Backend

The backend is provided [on demand](mailto:martin.stubenschrott@ait.ac.at) as a Docker image which opens
the rest service on port 8080.

**Step 1: Configuring Your Service**
TODO: How to 
- Steps to incorporate the received credentials into the service.
- Guidelines on setting up the service for proper communication with the [Tool Name].

**Step 2: Testing the Integration**
TODO!! (we will provide sample data)

# - Instructions for testing the integration to ensure everything is set up correctly.
# - Contact information for support in case of issues during testing.

## Output
If the front end and backend works correctly, the backend will
spit out the resulting trips as a JSON file:
```json
{
	"message": "success",
	"activities": [
		{
			"begin": "2020-07-15T13:20:41.059Z",
			"end": "2020-07-15T13:45:37.059Z",
			"mode": "WALK",
			"modeDetails": " | Sensor mode Walk | GPSQuality(AVERAGE : time gap)",
			"distanceMeters": 1253.2470899042082,
			"route": "ue`eHkddcB??????????rCrAj@Vj@Vh@Th@Vp@Xj@Xp@Xh@Tl@Vl@XJDp@Xn@Xp@Vp@XJDl@Tn@Rp@RRB@@D@?@?@???@???@@????????@???A?????????????????????????????????@????????????????????????Nh@??@E??@??@@B@B@B@@ACAAAC?AM]EICGCE?A???@?@BFBH@DP`A@F?D???B????A@A???EA??A??A????A@??????A????AA????CAI@??A@????A????????@?????B@B?D?B?F@D?B?H@H?F?D@B?@?@????C?CAC?CAGAGCG?CAA?AAA@??ABABCBABAB?@?@?BBBBD@D@F?DCDCBCBEBEBC@EBEBC@EBEBC@EBC@CBCBCBCBCBEBC@EBE@C@C@ABCBCBEBCBE@E@G@G@EBEBEBGBEBG@GBG@G?G?E?ECCEAEAEAECEECECEEECEECECCCCECCECCACACAEACAECECEEECEECCEEECECECECECEEECECECEAECEAECGCGCEEECE?C@CBE@C?CCECC?E?CBCFADCFCDABC@A@A?@A????A?A??@A???@A??@A??????@??A?@@?@??????A?A?AA???????????A?@???????@??@???@A??@?A???A@A?A??????@A??A??@A@???@???@?B????@??A?AA????A?????????A???@?????@?@?@?@?@A??@??????A???@@?A?A???????????A???A?A??????????@??@???A??@A???A@?A??@?@A@?@?@????@????A?????A?A?A?????A??????A????DA??????A??@????A???@??@?????@??A?????????@??????A?????CAAA?AAAA@???@A?????????@@@@?@????@@???????????????A?????????A???AA????????A?????A???@@@??@A?????A?@?????@??A?A@A@A@????@I@????B?@?A@??@?@ABCBA@A???"
		},
		{
			"begin": "2020-07-15T13:45:38.059Z",
			"end": "2020-07-15T13:51:20.059Z",
			"mode": "BUS",
			"modeDetails": "Line 69A (Hauptbahnhof - Simmering) (BUS) from Am Kanal to Arsenalsteg | Sensor mode Bus routed to Bus | GPSQuality(GOOD)",
			"distanceMeters": 2143.843162687046,
			"route": "ch_eHk_dcB????yA`ByAxA??gBbB??}AlA??{BrA??cBp@uBn@??cBZ??s@`C????????????????????AnD??ElC??EjCGlC??EtB??EtBGtB??IxD??KpC????????????????????A`D??IdE????c@xC??_AlB??CzC??m@lC??_AbB????????????qA`C????wBxD??_BfC??wAzB????}A~B????????????????iAbB??gAdB??gB`C??q@~@s@~@s@~@KW"
		},
		{
			"begin": "2020-07-15T13:51:29.059Z",
			"end": "2020-07-15T14:32:45.059Z",
			"mode": "WALK",
			"modeDetails": " | Sensor mode Walk | GPSQuality(BAD : large time gap)",
			"distanceMeters": 1435.4269300101091,
			"route": "mhaeHq{_cBE^@?AAACEAEAE?E?C?CACCCAC?E?CACCAG?CBEBABA@CBCBAB?@D?@?BCFA@C@CBAB?B@B@@@A@C@C@A@@@B?DABAB?B?@@@??@?BABA@?@?@B?D?D@D@F@D@D@F@F@D@FBD@F@FBH@FBHBFBFBFBHBF@HBF@DBF@FBDBDBDBFBD@FBD@D?B?@???????A??????????????@@?B@DBDBF@DBFBDBFBD@FBDBFBFBDBDBDBFBDBFBFBDBFBD@F@FBFBDB@DAD?DAB@D@B@@@A@CBC@CB?BDBFBF@FBD@BDBB@F@F@H?H@H@H@HBHBF@DBF@DBFBBDDDBDBDBDDBDBFBDDFBD@FBFBD@FBFBDBFBDDDDFDFBDDDBDBDBBBBBDBBBBD@B@DABABEBCBCBE@G@G@G@GBE@EBG@E?G@G?E@G?E@GBE@IBGBGDGBGBEBG@E@E@G@E@G@G@G@E@G@G?E@G?G@EBEBEBEBAD?D@FBDBBDDD@F@B@D?D@B?B@B@B??DJ?@@@?@B@LLDBFB@@@?@@@???@@@?@@@???@@@???@@@?@?@@??@@@?@?@@??@?@@@@DBB@NZ?@?@@@?@@??@?@?@@??@??@B??????????????AA???????A????EM??AC????AC?A???A????CG?AAC????????CI?AAA?A???????A??A????A??AE?????AA????A?????AAA?AAC?????A??????AAAE???A????M_@AACEAA??A??AAA??AAA?AA??MKAACCCACCECCCCACCEECCEAE?E@EDEDEFCDAHCHAHAHAH?FAF?DADCBADADAF?FAHAFAFAFAF?H?FAF?FAFCFCDCFCDCDCDEDCBEDCBCDAFCF?FAF@F?FAD?DADAFADCBADCDCDCDAFCDAFADAFCDCDCDCBADADADCDADCDADCFAH?HAF?HAF?F?H?F@FAD?FCFADAHAFAFAFAHAFADCFAF?D?F?D?D?FADADAFAFCFCHAFCFCHCDCFCDEBEDEBEDC@E?EACCEECACCCACCCCCCACCCCCCECCACCCACACA@A@A@?@?@?@?@?????????A??A?A?A?A?@@@?????????@?????@A@ABU??EH?@A@?@ABEJ?@ABA@CHW|@K^ADAH?@?????C?????A???@?????A?E?A?C?????J?@????A?@????????@???A????????????"
		}
	]
}
```

The format uses google encoded strings for the polylines of the trips.
We will, however, for the project also try to output GeoJSON
files directly, which might be easier to consume.

## Support and Contact

- For any questions, contact Martin Stubenschrott directly at
  [martin.stubenschrott@ait.ac.at](mailto:martin.stubenschrott@ait.ac.at)

## Important Notes

- You might get an API key for third-party routing services
  (e.g. Google Router). Make sure to keep that confident
  and **only** use it for testing and sparsingly.
  Overuse of the API key may result in high fees, as only
  about 20.000 requests/per month are free! For production,
  we must use a different key being used for billing.